<!DOCTYPE html>
<html>
<head>
    <title>Smart Office Assistant: Object Classifier</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap'); /* ‡πÉ‡∏ä‡πâ Font Kanit */

        body {
            font-family: 'Kanit', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #ece9e6, #ffffff); /* ‡πÑ‡∏•‡πà‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 2.2em;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        button.stop-btn {
            background-color: #dc3545;
        }
        button.stop-btn:hover {
            background-color: #c82333;
        }
        #webcam-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 20px auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background-color: #f8f9fa;
        }
        canvas {
            max-width: 100%;
            height: auto;
            display: block; /* ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ï‡πâ canvas */
        }
        .prediction-section {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .prediction-card {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            flex: 1 1 calc(33% - 40px); /* 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö desktop */
            min-width: 250px; /* ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: left;
        }
        .prediction-card h3 {
            color: #28a745;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.4em;
            font-weight: 600;
        }
        .prediction-card p {
            margin: 5px 0;
            font-size: 1.1em;
            color: #555;
        }
        .prediction-card .count {
            font-size: 1.8em;
            font-weight: 600;
            color: #007bff;
        }
        .status-message {
            font-size: 1.2em;
            margin-top: 20px;
            color: #666;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .prediction-card {
                flex: 1 1 calc(50% - 20px); /* 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tablet */
            }
        }
        @media (max-width: 480px) {
            .prediction-card {
                flex: 1 1 100%; /* 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile */
            }
            button {
                width: calc(100% - 10px);
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart Office Assistant: Object Classifier</h1>
        <p class="status-message">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ üìç **Mae Klong, Samut Songkhram**</p>

        <div class="controls">
            <button type="button" onclick="init('environment')">‚ñ∂Ô∏è Start (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)</button>
            <button type="button" onclick="init('user')">ü§≥ Start (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤)</button>
            <button type="button" class="stop-btn" onclick="stop()">‚èπÔ∏è Stop</button>
        </div>

        <div id="webcam-container"></div>
        
        <div class="prediction-section">
            <div class="prediction-card">
                <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <p id="current-object-label">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å...</p>
            </div>
            <div class="prediction-card">
                <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤</h3>
                <p class="count" id="pen-count">0</p>
            </div>
            <div class="prediction-card">
                <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏¥‡∏ô‡∏™‡∏≠</h3>
                <p class="count" id="pencil-count">0</p>
            </div>
            <div class="prediction-card">
                <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏á‡∏•‡∏ö</h3>
                <p class="count" id="eraser-count">0</p>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // URL ‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏• Teachable Machine ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const URL = "https://teachablemachine.withgoogle.com/models/c0b1jfmcI/"; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

        let model, webcam, maxPredictions;
        let mqttClient; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö MQTT Client
        let previous_class = "Empty"; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        let pen_count = 0;
        let pencil_count = 0;
        let eraser_count = 0;

        // Element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const currentObjectLabel = document.getElementById("current-object-label");
        const penCountElem = document.getElementById("pen-count");
        const pencilCountElem = document.getElementById("pencil-count");
        const eraserCountElem = document.getElementById("eraser-count");

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ MQTT Broker
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8000; // ‡πÉ‡∏ä‡πâ Port 8000 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö WebSocket
        const MQTT_TOPIC_PREFIX = "smart_office_assistant/"; // Topic Prefix ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT
        function connectMqtt() {
            if (mqttClient && mqttClient.connected) {
                console.log("MQTT Client already connected.");
                return;
            }
            console.log("Attempting to connect to MQTT broker...");
            mqttClient = mqtt.connect(`ws://${MQTT_BROKER}:${MQTT_PORT}/mqtt`); // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô WebSocket

            mqttClient.on('connect', function () {
                console.log("Connected to MQTT Broker!");
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á subscribe ‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà publish
            });

            mqttClient.on('error', function (err) {
                console.error("MQTT Connection error:", err);
                currentObjectLabel.innerText = "MQTT Error: " + err.message;
            });

            mqttClient.on('close', function () {
                console.log("MQTT connection closed.");
            });

            mqttClient.on('reconnect', function () {
                console.log("MQTT reconnecting...");
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Publish ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡πà‡∏≤‡∏ô MQTT
        function publishMqtt(topic, message) {
            if (mqttClient && mqttClient.connected) {
                mqttClient.publish(MQTT_TOPIC_PREFIX + topic, String(message));
                console.log(`Published to ${MQTT_TOPIC_PREFIX}${topic}: ${message}`);
            } else {
                console.warn("MQTT Client not connected. Cannot publish message.");
            }
        }

        async function init(facingMode) {
            // ‡∏´‡∏¢‡∏∏‡∏î webcam ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (webcam && webcam.canvas) {
                stop();
            }

            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
            } catch (e) {
                console.error("Failed to load model:", e);
                currentObjectLabel.innerText = "Error loading model. Check URL or network.";
                return;
            }

            webcam = new tmImage.Webcam(224, 224, false); // ‡πÉ‡∏ä‡πâ 224x224 ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            try {
                await webcam.setup({ facingMode: facingMode });
                await webcam.play();
                if (!webcam.canvas) {
                    throw new Error("Webcam canvas is not initialized");
                }
                console.log("Webcam initialized, facingMode:", facingMode);
                document.getElementById("webcam-container").innerHTML = ''; // Clear previous webcam
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                window.requestAnimationFrame(loop);
                connectMqtt(); // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MQTT ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Webcam ‡∏û‡∏£‡πâ‡∏≠‡∏°
            } catch (e) {
                console.error("Webcam setup failed:", e);
                currentObjectLabel.innerText = "Error: " + e.message + ". Please ensure camera access.";
                return;
            }

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
            pen_count = 0;
            pencil_count = 0;
            eraser_count = 0;
            previous_class = "Empty"; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà
            updateCountsDisplay();
            currentObjectLabel.innerText = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...";
        }

        async function loop() {
            if (!webcam || !webcam.canvas) return; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ webcam ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            if (!model || !webcam || !webcam.canvas) return;

            const prediction = await model.predict(webcam.canvas);
            let current_class_name = "Unknown";
            let maxProb = 0;

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > maxProb) {
                    maxProb = prediction[i].probability;
                    current_class_name = prediction[i].className;
                }
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            currentObjectLabel.innerText = `${current_class_name} (${(maxProb * 100).toFixed(1)}%)`;

            // Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î
            if (current_class_name !== previous_class) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏•‡∏≤‡∏™
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏
                if (current_class_name !== "Empty" && previous_class === "Empty") {
                    if (current_class_name === "Pen") {
                        pen_count++;
                        publishMqtt("pen_added", 1); // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤ Pen ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°
                    } else if (current_class_name === "Pencil") {
                        pencil_count++;
                        publishMqtt("pencil_added", 1);
                    } else if (current_class_name === "Eraser") {
                        eraser_count++;
                        publishMqtt("eraser_added", 1);
                    }
                    publishMqtt("current_object", current_class_name); // ‡∏™‡πà‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                }
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏≠‡∏≠‡∏Å
                else if (current_class_name === "Empty" && previous_class !== "Empty") {
                    if (previous_class === "Pen" && pen_count > 0) { // ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö
                        pen_count--;
                        publishMqtt("pen_removed", 1); // ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤ Pen ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å
                    } else if (previous_class === "Pencil" && pencil_count > 0) {
                        pencil_count--;
                        publishMqtt("pencil_removed", 1);
                    } else if (previous_class === "Eraser" && eraser_count > 0) {
                        eraser_count--;
                        publishMqtt("eraser_removed", 1);
                    }
                    publishMqtt("current_object", "Empty"); // ‡∏™‡πà‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                }

                updateCountsDisplay(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                publishMqtt("inventory/pen", pen_count);
                publishMqtt("inventory/pencil", pencil_count);
                publishMqtt("inventory/eraser", eraser_count);
                
                previous_class = current_class_name; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            }
        }

        function updateCountsDisplay() {
            penCountElem.innerText = pen_count;
            pencilCountElem.innerText = pencil_count;
            eraserCountElem.innerText = eraser_count;
        }

        function stop() {
            if (webcam) {
                webcam.stop();
                document.getElementById("webcam-container").innerHTML = '';
                currentObjectLabel.innerText = "‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
            }
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
                console.log("MQTT Client disconnected.");
            }
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            pen_count = 0;
            pencil_count = 0;
            eraser_count = 0;
            previous_class = "Empty";
            updateCountsDisplay();
        }
    </script>
</body>
</html>
